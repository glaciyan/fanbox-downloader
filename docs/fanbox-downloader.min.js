var k=class{constructor(){this.audioExtension=/\.(mp3|m4a|ogg)$/,this.imageExtension=/\.(apng|avif|gif|jpg|jpeg|jfif|pjpeg|pjp|png|svg|webp)$/,this.videoExtension=/\.(mp4|webm|ogv)$/}isAudio(e){return e.match(this.audioExtension)!=null}isImage(e){return e.match(this.imageExtension)!=null}isVideo(e){return e.match(this.videoExtension)!=null}httpGetAs(e){let t=new XMLHttpRequest;return t.open("GET",e,!1),t.withCredentials=!0,t.send(null),JSON.parse(t.responseText)}encodeFileName(e){return e.replace(/\//g,"\uFF0F").replace(/\\/g,"\uFF3C").replace(/,/g,"\uFF0C").replace(/:/g,"\uFF1A").replace(/\*/g,"\uFF0A").replace(/"/g,"\u201C").replace(/</g,"\uFF1C").replace(/>/g,"\uFF1E").replace(/\|/g,"\uFF5C").trimEnd()}encodeURI(e){return this.encodeFileName(e).replaceAll(/[;,/?:@&=+$#]/g,encodeURIComponent)}splitExt(e){return e.split(/(?=\.[^.]+$)/)}getFileName(e,t,n,o,i){return n<=1?`${e}${t}`:i?`${e}_${o+1}${t}`:`${e}_${n-o}${t}`}toQuoted(e){return`'${e.replaceAll("'","\\'")}'`}createInformationFile(e){try{return{name:"info.json",content:[JSON.stringify(JSON.parse(e),null,"	")]}}catch{return{name:"info.txt",content:[e]}}}async sleep(e){return new Promise(t=>setTimeout(t,e))}async fetchWithLimit({url:e,name:t},n){if(n<0)return null;try{let o=await fetch(e).catch(i=>{throw new Error(i)}).then(i=>i.ok?i.blob():null);return o||await this.fetchWithLimit({url:e,name:t},n-1)}catch{return console.error(`\u901A\u4FE1\u30A8\u30E9\u30FC: ${t}, ${e}`),await this.sleep(1e3),await this.fetchWithLimit({url:e,name:t},n-1)}}async embedScript(e){return new Promise((t,n)=>{let o=document.createElement("script");o.src=e,o.onload=()=>t(o),o.onerror=i=>n(i),document.head.appendChild(o)})}},S=class{constructor(e,t){this.orderedPosts=[],this.url="#main",this.downloadObj={posts:{},id:e},this.utils=t}stringify(){var e;let t={posts:this.orderedPosts.map(n=>n.toJsonObjBy(this.downloadObj.posts)),id:this.downloadObj.id,url:this.url,tags:(e=this.tags)!==null&&e!==void 0?e:this.collectTags(),postCount:this.countPost(),fileCount:this.countFile()};return JSON.stringify(t)}setUrl(e){this.url=e}setTags(e){this.tags=e}addPost(e){let t=this.utils.encodeFileName(e);this.downloadObj.posts[t]===void 0&&(this.downloadObj.posts[t]=[]);let n={name:e,info:"",files:{},html:"",tags:[]};this.downloadObj.posts[t].push(n);let o=new L(n,this.utils);return this.orderedPosts.push(o),o}countPost(){return Object.values(this.downloadObj.posts).reduce((e,t)=>e+t.length,0)}countFile(){return Object.values(this.downloadObj.posts).reduce((e,t)=>e+t.reduce((n,o)=>n+Object.values(o.files).reduce((i,r)=>i+r.length,0),0),0)}collectTags(){let e=new Set;return Object.values(this.downloadObj.posts).forEach(t=>t.forEach(n=>n.tags.forEach(o=>e.add(o)))),[...e]}},L=class{constructor(e,t){this.postObj=e,this.utils=t}setInfo(e){this.postObj.info=e}setHtml(e){this.postObj.html=e}setTags(e){this.postObj.tags=e}setCover(e,t,n){let o={name:e,extension:t?`.${t}`:"",url:n};return this.postObj.cover=o,new j(o,this.utils)}addFile(e,t,n){let o=this.utils.encodeFileName(e);this.postObj.files[o]===void 0&&(this.postObj.files[o]=[]);let i={name:e,extension:t?`.${t}`:"",url:n};return this.postObj.files[o].push(i),new j(i,this.utils)}getAutoAssignedLinkTag(e){let t=e.getEncodedExtension();switch(!0){case this.utils.isAudio(t):return this.getAudioLinkTag(e);case this.utils.isImage(t):return this.getImageLinkTag(e);case this.utils.isVideo(t):return this.getVideoLinkTag(e);default:return this.getFileLinkTag(e)}}getAudioLinkTag(e){let t=this.getCurrentFilePath(e);return`<a class="hl" href="${t}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card">
<div class="card-header">${e.getOriginalName()}</div>
<audio class="card-img-top" src="${t}" controls/>
</div></a>`}getLinkTag(e,t){return`<a class="hl" href="${e}"><div class="post card text-center"><p class="pt-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-left" viewBox="0 0 16 16">
<path fill-rule="evenodd" d="M7.364 3.5a.5.5 0 0 1 .5-.5H14.5A1.5 1.5 0 0 1 16 4.5v10a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 3 14.5V7.864a.5.5 0 1 1 1 0V14.5a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5v-10a.5.5 0 0 0-.5-.5H7.864a.5.5 0 0 1-.5-.5z"/>
<path fill-rule="evenodd" d="M0 .5A.5.5 0 0 1 .5 0h5a.5.5 0 0 1 0 1H1.707l8.147 8.146a.5.5 0 0 1-.708.708L1 1.707V5.5a.5.5 0 0 1-1 0v-5z"/>
</svg> ${t}</p></div></a>`}getFileLinkTag(e){return`<a class="hl" href="${this.getCurrentFilePath(e)}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card text-center"><p class="pt-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
<path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
</svg> ${e.getOriginalName()+e.getOriginalExtension()}</p></div></a>`}getImageLinkTag(e){let t=this.getCurrentFilePath(e);return`<a class="hl" href="${t}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card">
<img class="card-img-top" src="${t}" alt="${e.getOriginalName()}"/>
</div></a>`}getVideoLinkTag(e){let t=this.getCurrentFilePath(e);return`<a class="hl" href="${t}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card">
<video class="card-img-top" src="${t}" controls/>
</div></a>`}getCurrentFilePath(e){let t=e.getEncodedName();if(e.equals(this.postObj.cover)){let i=this.utils.getFileName(t,e.getEncodedExtension(),1,0,!0);return`./${this.utils.encodeURI(i)}`}if(this.postObj.files[t]===void 0)throw new Error(`file object is undefined: ${e.getOriginalName()}`);let n=this.postObj.files[t].findIndex(i=>e.equals(i));if(n<0)throw new Error(`file object is not found: ${e.getOriginalName()}`);let o=this.utils.getFileName(t,e.getEncodedExtension(),this.postObj.files[t].length,n,!0);return`./${this.utils.encodeURI(o)}`}toJsonObjBy(e){var t;let n=this.utils.encodeFileName(this.postObj.name),o=(t=e[n])===null||t===void 0?void 0:t.indexOf(this.postObj);if(o===void 0||o<0)throw new Error(`post object is not found: ${this.postObj.name}`);let i=this.utils.getFileName(n,"",e[n].length,o,!1),r=this.postObj.cover?{url:this.postObj.cover.url,name:this.utils.getFileName(this.postObj.cover.name,this.postObj.cover.extension,1,0,!0)}:void 0;return{originalName:this.postObj.name,encodedName:i,informationText:this.postObj.info,htmlText:this.postObj.html,files:this.collectFiles(),tags:this.postObj.tags,cover:r}}collectFiles(){let e=[];for(let[t,n]of Object.entries(this.postObj.files)){let o=0;for(let i of n){let r=i.extension?this.utils.encodeFileName(i.extension):"",a=this.utils.getFileName(t,r,n.length,o++,!0);e.push({url:i.url,originalName:i.name,encodedName:a})}}return e}},j=class{constructor(e,t){this.fileObj=e,this.utils=t}getEncodedName(){return this.utils.encodeFileName(this.fileObj.name)}getEncodedExtension(){return this.utils.encodeFileName(this.fileObj.extension)}getOriginalName(){return this.fileObj.name}getOriginalExtension(){return this.fileObj.extension}getUrl(){return this.fileObj.url}equals(e){return typeof e!="object"?!1:e.name===this.fileObj.name&&e.url===this.fileObj.url}},E=class{constructor(e){this.bootCSS={href:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css",integrity:"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"},this.bootJS={src:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js",integrity:"sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"},this.vueJS={src:"https://unpkg.com/vue@3.2.28/dist/vue.global.js"},this.utils=e}async createDownloadUI(e){document.head.innerHTML="",document.body.innerHTML="",document.getElementsByTagName("html")[0].style.height="100%",document.body.style.height="100%",document.body.style.margin="0",document.title=e;let t=document.createElement("link");t.href=this.bootCSS.href,t.rel="stylesheet",t.integrity=this.bootCSS.integrity,t.crossOrigin="anonymous",document.head.appendChild(t);let n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.flexDirection="column",n.style.height="100%";let o=document.createElement("div");o.className="input-group mb-2",o.style.width="400px";let i=document.createElement("input");i.type="text",i.className="form-control",i.placeholder="\u3053\u3053\u306BJSON\u3092\u8CBC\u308A\u4ED8\u3051",o.appendChild(i);let r=document.createElement("div");r.className="input-group-append";let a=document.createElement("button");a.className="btn btn-outline-secondary btn-labeled",a.type="button",a.innerText="Download",r.appendChild(a),o.appendChild(r),n.appendChild(o);let d=document.createElement("div");d.className="progress mb-3",d.style.width="400px";let c=document.createElement("div");c.className="progress-bar",c.role="progressbar",c["aria-valuemin"]="0",c["aria-valuemax"]="100",c["aria-valuenow"]="0",c.style.width="0%",c.innerText="0%";let l=h=>{c["aria-valuenow"]=`${h}`,c.style.width=`${h}%`,c.innerText=`${h}%`};d.appendChild(c),n.appendChild(d);let x=document.createElement("div");x.style.width="350px";let g=document.createElement("div");g.className="form-check float-start";let f=document.createElement("input");f.className="form-check-input",f.type="checkbox",f.id="LogCheck",f.checked=!0,g.appendChild(f);let b=document.createElement("label");b.className="form-check-label",b.for="LogCheck",b.innerText="\u30ED\u30B0\u3092\u81EA\u52D5\u30B9\u30AF\u30ED\u30FC\u30EB",g.appendChild(b),x.appendChild(g);let y=document.createElement("div");y.className="float-end",y.innerText="\u6B8B\u308A\u304A\u3088\u305D -:--";let u=h=>y.innerText=`\u6B8B\u308A\u304A\u3088\u305D ${h}`;x.appendChild(y),n.appendChild(x);let m=document.createElement("textarea");m.className="form-control",m.readOnly=!0,m.style.resize="both",m.style.width="500px",m.style.height="80px";let p=h=>{m.value+=`${h}
`,f.checked&&(m.scrollTop=m.scrollHeight)};n.appendChild(m),document.body.appendChild(n);let w=document.createElement("script");w.src=this.bootJS.src,w.integrity=this.bootJS.integrity,w.crossOrigin="anonymous",document.body.appendChild(w);let F=this.downloadZip.bind(this);a.onclick=async()=>{a.disabled=!0;let h=O=>O.returnValue="downloading";window.addEventListener("beforeunload",h);try{await F(JSON.parse(i.value),l,p,u)}catch(O){p("\u30A8\u30E9\u30FC\u51FA\u305F"),console.error(O)}finally{window.removeEventListener("beforeunload",h)}}}async downloadZip(e,t,n,o){if(!this.isDownloadJsonObj(e))throw new Error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u5BFE\u8C61\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63");let i=this,r=this.utils;await r.embedScript("https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js"),await r.embedScript("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.js"),await r.embedScript("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/examples/zip-stream.js");let a=r.encodeFileName(e.id),d=streamSaver.createWriteStream(`${a}.zip`),c=new createWriter({async pull(f){let b=Math.floor(Date.now()/1e3),y=0,u=(p,w)=>f.enqueue(new File(p,`${a}/${w}`));n(`@${e.id} \u6295\u7A3F:${e.postCount} \u30D5\u30A1\u30A4\u30EB:${e.fileCount}`),u([i.createRootHtmlFromPosts(e)],"index.html");let m=0;for(let p of e.posts){n(`${p.originalName} (${++m}/${e.postCount})`);let w=r.createInformationFile(p.informationText);if(u(w.content,`${p.encodedName}/${r.encodeFileName(w.name)}`),u([i.createHtmlFromBody(p.originalName,p.htmlText)],`${p.encodedName}/index.html`),p.cover){n(`download ${p.cover.name}`);let h=await r.fetchWithLimit(p.cover,1);h&&u([h],`${p.encodedName}/${p.cover.name}`)}let F=0;for(let h of p.files){n(`download ${h.encodedName} (${++F}/${p.files.length})`);let O=await r.fetchWithLimit({url:h.url,name:h.encodedName},1);O?u([O],`${p.encodedName}/${h.encodedName}`):(console.error(`${h.encodedName}(${h.url})\u306E\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u306B\u5931\u6557\u3001\u8AAD\u307F\u98DB\u3070\u3059\u3088`),n(`${h.encodedName}\u306E\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u306B\u5931\u6557`)),y++,setTimeout(()=>{let M=Math.floor(Math.abs(Math.floor(Date.now()/1e3)-b)*(e.fileCount-y)/y),A=M/(60*60)|0,Y=Math.ceil((M-60*60*A)/60);o(`${A}:${("00"+Y).slice(-2)}`),t(y*100/e.fileCount|0)},0),await r.sleep(100)}}f.close()}});if(window.WritableStream&&c.pipeTo)return c.pipeTo(d).then(()=>console.log("done writing"));let l=d.getWriter(),x=c.getReader(),g=()=>x.read().then(f=>f.done?l.close():l.write(f.value).then(g));await g()}isDownloadJsonObj(e){switch(!0){case typeof e!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(\u5BFE\u8C61\u304Cobject\u3067\u306A\u3044)",e),!1;case typeof e.postCount!="number":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(postCount\u304C\u6570\u5024\u3067\u306A\u3044)",e.postCount),!1;case typeof e.fileCount!="number":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(fileCount\u304C\u6570\u5024\u3067\u306A\u3044)",e.fileCount),!1;case typeof e.id!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(id\u304C\u6587\u5B57\u5217\u3067\u306A\u3044)",e.id),!1;case typeof e.url!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(url\u304C\u6587\u5B57\u5217\u3067\u306A\u3044)",e.url),!1;case!Array.isArray(e.posts):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u304C\u914D\u5217\u3067\u306A\u3044)",e.posts),!1;case!Array.isArray(e.tags):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(tags\u304C\u914D\u5217\u3067\u306A\u3044)",e.tags),!1}return!e.posts.some(t=>{switch(!0){case typeof t!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Bobject\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t,e.posts),!0;case typeof t.informationText!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306BinformationText\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.informationText,e.posts),!0;case typeof t.htmlText!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306BhtmlText\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.htmlText,e.posts),!0;case!Array.isArray(t.files):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Bfiles\u304C\u914D\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.files,e.posts),!0;case!Array.isArray(t.tags):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Btags\u304C\u914D\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.tags,e.posts),!0;case t.files.some(n=>{var o,i,r,a;switch(!0){case typeof n!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306B\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",n,t.files),!0;case typeof n.url!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306Burl\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",n.url,t.files),!0;case typeof n.originalName!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306BoriginalName\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",n.originalName,t.files),!0;case typeof n.encodedName!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306BencodedName\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",n.encodedName,t.files),!0;case t.cover===void 0:return!1;case typeof t.cover!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Bcover\u304Cobject\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.cover,e.posts),!0;case typeof((o=t.cover)===null||o===void 0?void 0:o.url)!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Ecover\u306E\u5024\u306Burl\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",(i=t.cover)===null||i===void 0?void 0:i.url,t.cover),!0;case typeof((r=t.cover)===null||r===void 0?void 0:r.name)!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Ecover\u306E\u5024\u306Bname\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",(a=t.cover)===null||a===void 0?void 0:a.name,t.cover),!0;default:return!1}}):return!0;default:return!1}})}createRootHtmlFromPosts(e){let t=`<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>${e.id}</title>
<link href="${this.bootCSS.href}" rel="stylesheet" integrity="${this.bootCSS.integrity}" crossOrigin="anonymous">
<style>div.main{width: 600px; float: none; margin: 65px auto 0}div.root{width: 400px}div.post{width: 600px}a.hl,a.hl:hover{color: inherit;text-decoration: none;}div.card{float: none; margin: 0 auto;}img.gray-card{height: 210px;background-color: gray;}div.gray-carousel{height: 210px; width: 400px;background-color: gray;}img.pd-carousel{height: 210px; padding: 15px;}</style>
</head>
<body>
<div class="main" id="main">
`,n=`<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top"><div class="container-fluid">
<a class="navbar-brand" href="${e.url}">${e.id}</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#dd" aria-controls="dd" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="dd"><ul class="navbar-nav">
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tags</a>
<ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dd">
<li v-for="(tag,i) in [${e.tags.map(i=>this.utils.toQuoted(i)).join(",")}]">
 <div class="form-check mx-1">
<input class="form-check-input" type="checkbox" v-model="selected" :value="tag" :id="'box'+(i+1)">
<label class="form-check-label" :for="'box'+(i+1)">{{tag}}</label>
</div>
</li>
</ul>
</li>
</ul></div>
</div></nav>

`+e.posts.map(i=>`<div v-show="isVisible([${i.tags.map(r=>this.utils.toQuoted(r)).join(", ")}], selected)">
<a class="hl" href="./${this.utils.encodeURI(i.encodedName)}/index.html"><div class="root card">
`+this.createCoverHtmlFromPost(i)+`<div class="card-body"><h5 class="card-title">${i.originalName}</h5></div>
</div></a><br>
</div>
`).join(`
`),o=`
</div>
<script src="${this.vueJS.src}"><\/script>
<script>
Vue.createApp({
data() {return { selected: [] }},methods: {
 isVisible(tags, selected) {
  if (!selected.length) return true
  return selected.every(it => tags.includes(it))
 }
}
}).mount('#main')
<\/script>
<script src="${this.bootJS.src}" integrity="${this.bootJS.integrity}" crossOrigin="anonymous"><\/script>
</body></html>`;return t+n+o}createCoverHtmlFromPost(e){let t=`./${this.utils.encodeURI(e.encodedName)}/`;if(e.cover)return`<img class="card-img-top gray-card" src="${t}${this.utils.encodeURI(e.cover.name)}" alt="\u30AB\u30D0\u30FC\u753B\u50CF"/>
`;let n=e.files.filter(o=>this.utils.isImage(o.encodedName));return n.length>0?`<div class="carousel slide" data-bs-ride="carousel" data-interval="1000"><div class="carousel-inner">
<div class="carousel-item active">`+n.map(o=>`<div class="d-flex justify-content-center gray-carousel"><img src="${t}${this.utils.encodeURI(o.encodedName)}" class="d-block pd-carousel" height="180px"/></div>`).join(`</div>
<div class="carousel-item">`)+`</div>
</div></div>
`:`<img class="card-img-top gray-card"/>
`}createHtmlFromBody(e,t){return`<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>${e}</title>
<link href="${this.bootCSS.href}" rel="stylesheet" integrity="${this.bootCSS.integrity}" crossOrigin="anonymous">
<style>div.main{width: 600px; float: none; margin: 0 auto}div.root{width: 400px}div.post{width: 600px}a.hl,a.hl:hover{color: inherit;text-decoration: none;}div.card{float: none; margin: 0 auto;}img.gray-card{height: 210px;background-color: gray;}div.gray-carousel{height: 210px; width: 400px;background-color: gray;}img.pd-carousel{height: 210px; padding: 15px;}</style>
</head>
<body>
<div class="main">
${t}
</div>
<script src="${this.bootJS.src}" integrity="${this.bootJS.integrity}" crossOrigin="anonymous"><\/script>
</body></html>`}};var de=Symbol.for("constructDateFrom");var G={},D={};function C(s,e){try{let n=(G[s]||=new Intl.DateTimeFormat("en-GB",{timeZone:s,hour:"numeric",timeZoneName:"longOffset"}).format)(e).split("GMT")[1]||"";return n in D?D[n]:P(n,n.split(":"))}catch{if(s in D)return D[s];let t=s?.match(K);return t?P(s,t.slice(1)):NaN}}var K=/([+-]\d\d):?(\d\d)?/;function P(s,e){let t=+e[0],n=+(e[1]||0);return D[s]=t>0?t*60+n:t*60-n}var T=class s extends Date{constructor(...e){super(),e.length>1&&typeof e[e.length-1]=="string"&&(this.timeZone=e.pop()),this.internal=new Date,isNaN(C(this.timeZone,this))?this.setTime(NaN):e.length?typeof e[0]=="number"&&(e.length===1||e.length===2&&typeof e[1]!="number")?this.setTime(e[0]):typeof e[0]=="string"?this.setTime(+new Date(e[0])):e[0]instanceof Date?this.setTime(+e[0]):(this.setTime(+new Date(...e)),R(this,NaN)):this.setTime(Date.now()),B(this)}static tz(e,...t){return t.length?new s(...t,e):new s(Date.now(),e)}withTimeZone(e){return new s(+this,e)}getTimezoneOffset(){return-C(this.timeZone,this)}[Symbol.for("constructDateFrom")](e){return new s(+new Date(e),this.timeZone)}},H=/^(get|set)(?!UTC)/;Object.getOwnPropertyNames(Date.prototype).forEach(s=>{if(!H.test(s))return;let e=s.replace(H,"$1UTC");T.prototype[e]&&(s.startsWith("get")?T.prototype[s]=function(){return this.internal[e]()}:(T.prototype[s]=function(){return Date.prototype[e].apply(this.internal,arguments),Q(this),+this},T.prototype[e]=function(){return Date.prototype[e].apply(this,arguments),B(this),+this}))});function B(s){s.internal.setTime(+s),s.internal.setUTCMinutes(s.internal.getUTCMinutes()-s.getTimezoneOffset())}function Q(s){Date.prototype.setFullYear.call(s,s.internal.getUTCFullYear(),s.internal.getUTCMonth(),s.internal.getUTCDate()),Date.prototype.setHours.call(s,s.internal.getUTCHours(),s.internal.getUTCMinutes(),s.internal.getUTCSeconds(),s.internal.getUTCMilliseconds()),R(s)}function R(s){let e=C(s.timeZone,s),t=new Date(+s);t.setUTCHours(t.getUTCHours()-1);let n=-new Date(+s).getTimezoneOffset(),o=-new Date(+t).getTimezoneOffset(),i=n-o,r=Date.prototype.getHours.apply(s)!==s.internal.getUTCHours();i&&r&&s.internal.setUTCMinutes(s.internal.getUTCMinutes()+i);let a=n-e;a&&Date.prototype.setUTCMinutes.call(s,Date.prototype.getUTCMinutes.call(s)+a);let d=C(s.timeZone,s),l=-new Date(+s).getTimezoneOffset()-d,x=d!==e,g=l-a;if(x&&g){Date.prototype.setUTCMinutes.call(s,Date.prototype.getUTCMinutes.call(s)+g);let f=C(s.timeZone,s),b=d-f;b&&(s.internal.setUTCMinutes(s.internal.getUTCMinutes()+b),Date.prototype.setUTCMinutes.call(s,Date.prototype.getUTCMinutes.call(s)+b))}}var N=class s extends T{static tz(e,...t){return t.length?new s(...t,e):new s(Date.now(),e)}toISOString(){let[e,t,n]=this.tzComponents(),o=`${e}${t}:${n}`;return this.internal.toISOString().slice(0,-1)+o}toString(){return`${this.toDateString()} ${this.toTimeString()}`}toDateString(){let[e,t,n,o]=this.internal.toUTCString().split(" ");return`${e?.slice(0,-1)} ${n} ${t} ${o}`}toTimeString(){let e=this.internal.toUTCString().split(" ")[4],[t,n,o]=this.tzComponents();return`${e} GMT${t}${n}${o} (${_(this.timeZone,this)})`}toLocaleString(e,t){return Date.prototype.toLocaleString.call(this,e,{...t,timeZone:t?.timeZone||this.timeZone})}toLocaleDateString(e,t){return Date.prototype.toLocaleDateString.call(this,e,{...t,timeZone:t?.timeZone||this.timeZone})}toLocaleTimeString(e,t){return Date.prototype.toLocaleTimeString.call(this,e,{...t,timeZone:t?.timeZone||this.timeZone})}tzComponents(){let e=this.getTimezoneOffset(),t=e>0?"-":"+",n=String(Math.floor(Math.abs(e)/60)).padStart(2,"0"),o=String(Math.abs(e)%60).padStart(2,"0");return[t,n,o]}withTimeZone(e){return new s(+this,e)}[Symbol.for("constructDateFrom")](e){return new s(+new Date(e),this.timeZone)}};function _(s,e){return new Intl.DateTimeFormat("en-GB",{timeZone:s,timeZoneName:"long"}).format(e).slice(12)}var X=Math.pow(10,8)*24*60*60*1e3,ke=-X;var ee=3600;var J=ee*24,Se=J*7,te=J*365.2425,ne=te/12,je=ne*3,U=Symbol.for("constructDateFrom");function z(s,e){return typeof s=="function"?s(e):s&&typeof s=="object"&&U in s?s[U](e):s instanceof Date?new s.constructor(e):new Date(e)}function Z(s,e){return z(e||s,s)}function $(s,e){let t=s<0?"-":"",n=Math.abs(s).toString().padStart(e,"0");return t+n}function V(s,e){let t=Z(s,e?.in);if(isNaN(+t))throw new RangeError("Invalid time value");let n=e?.format??"extended",o=e?.representation??"complete",i="",r="",a=n==="extended"?"-":"",d=n==="extended"?":":"";if(o!=="time"){let c=$(t.getDate(),2),l=$(t.getMonth()+1,2);i=`${$(t.getFullYear(),4)}${a}${l}${a}${c}`}if(o!=="date"){let c=t.getTimezoneOffset();if(c!==0){let y=Math.abs(c),u=$(Math.trunc(y/60),2),m=$(y%60,2);r=`${c<0?"+":"-"}${u}:${m}`}else r="Z";let l=$(t.getHours(),2),x=$(t.getMinutes(),2),g=$(t.getSeconds(),2),f=i===""?"":"T",b=[l,x,g].join(d);i=`${i}${f}${b}${r}`}return i}var v=class s{constructor(e,t){this.userId=e;this.feeMap=t;this.isIgnoreFree=!1;this.fees=[];this.tags=[];this.isLimitAvailable=!1;this.limit=0;this.downloadObject=new S(e,s.utils)}static{this.utils=new k}static{this.isExportJson=!0}addFee(e){this.fees=[...new Set([...this.fees,e])]}addTags(...e){this.tags=[...new Set([...this.tags,...e])]}applyTags(){let e=this.fees.sort((n,o)=>n-o).map(n=>this.getTagByFee(n)),t=this.tags.filter(n=>!e.includes(n));this.downloadObject.setTags([...e,...t])}getTagByFee(e){return this.feeMap.get(e)??(e>0?`${e}\u5186`:"\u7121\u6599")+"\u30D7\u30E9\u30F3"}setLimitAvailable(e){this.isLimitAvailable=e}isLimitValid(){return this.isLimitAvailable?this.limit>0:!0}decrementLimit(){this.isLimitAvailable&&this.limit--}setLimit(e){this.isLimitAvailable&&(this.limit=e)}};async function ze(){let s;if(window.location.origin==="https://downloads.fanbox.cc"){await new E(v.utils).createDownloadUI("fanbox-downloader");return}else if(window.location.origin==="https://www.fanbox.cc"){let n=window.location.href.match(/fanbox.cc\/@([^\/]*)/)?.[1],o=window.location.href.match(/fanbox.cc\/@.*\/posts\/(\d*)/)?.[1];s=await q(n,o)}else if(window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//)){let n=window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//)?.[1],o=window.location.href.match(/.*\.fanbox\.cc\/posts\/(\d*)/)?.[1];s=await q(n,o)}else{alert(`\u3053\u3053\u3069\u3053\u3067\u3059\u304B(${window.location.href})`);return}if(!s)return;let e=s.stringify();console.log(e);let t=()=>{alert("json\u3092\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F\u3002downloads.fanbox.cc\u3067\u5B9F\u884C\u3057\u3066\u8CBC\u308A\u4ED8\u3051\u3066\u306D"),confirm("downloads.fanbox.cc\u306B\u9077\u79FB\u3059\u308B\uFF1F")&&window.open("https://downloads.fanbox.cc","_blank")};try{await navigator.clipboard.writeText(e),t()}catch{document.body.addEventListener("click",()=>{navigator.clipboard.writeText(e).then(()=>t()).catch(()=>alert("json\u30B3\u30D4\u30FC\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u3082\u3046\u4E00\u5EA6\u5B9F\u884C\u3059\u308B\u304B\u30B3\u30F3\u30BD\u30FC\u30EB\u304B\u3089\u30B3\u30D4\u30FC\u3057\u3066\u306D"))},{once:!0}),alert("json\u30B3\u30D4\u30FC\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u753B\u9762\u306E\u9069\u5F53\u306A\u3068\u3053\u3092\u30AF\u30EA\u30C3\u30AF\uFF01")}}async function q(s,e){if(!s){alert("\u3057\u3089\u306A\u3044URL");return}let t=v.utils.httpGetAs(`https://api.fanbox.cc/plan.listCreator?creatorId=${s}`).body,n=new Map;t?.forEach(r=>n.set(r.fee,r.title));let o=new v(s,n);o.downloadObject.setUrl(`https://www.fanbox.cc/@${s}`);let i=v.utils.httpGetAs(`https://api.fanbox.cc/tag.getFeatured?creatorId=${s}`).body?.map(r=>r.tag)??[];return o.addTags(...i),e?I(o,W(e)):await se(o),o.applyTags(),o.downloadObject}async function se(s){s.isIgnoreFree=confirm("\u7121\u6599\u30B3\u30F3\u30C6\u30F3\u30C4\u3092\u7701\u304F\uFF1F");let e=prompt("\u53D6\u5F97\u5236\u9650\u6570\u3092\u5165\u529B \u30AD\u30E3\u30F3\u30BB\u30EB\u3067\u5168\u3066\u53D6\u5F97");if(e){let n=Number.parseInt(e);n&&(s.setLimitAvailable(!0),s.setLimit(n))}let t=v.utils.httpGetAs(`https://api.fanbox.cc/post.paginateCreator?creatorId=${s.userId}`).body;for(let n=0;n<t.length;n++)console.log(`${n+1}\u56DE\u76EE`),await oe(s,t[n]),await v.utils.sleep(10)}async function oe(s,e){let t=v.utils.httpGetAs(e).body;console.log(`\u6295\u7A3F\u306E\u6570:${t.length}`);for(let n of t)if(s.isLimitValid())n.body?I(s,n):n.isRestricted||(await v.utils.sleep(10),I(s,W(n.id)));else break}function W(s){return v.utils.httpGetAs(`https://api.fanbox.cc/post.info?postId=${s}`).body}function I(s,e){if(!e||s.isIgnoreFree&&e.feeRequired===0)return;if(!e.body||e.isRestricted){console.log(`\u53D6\u5F97\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F(\u652F\u63F4\u304C\u305F\u308A\u306A\u3044\uFF1F)
feeRequired: ${e.feeRequired}@${e.id}`);return}let t=e.title,n=s.downloadObject.addPost(`${V(new N(e.publishedDatetime,"Asia/Tokyo"),{representation:"date"})}_${t}`);n.setTags([s.getTagByFee(e.feeRequired),...e.tags]),s.addFee(e.feeRequired),s.addTags(...e.tags);let o=(a=>{if(a){let d=a.split(".").pop()??"";return`${n.getImageLinkTag(n.setCover("cover",d,a))}<h5>${t}</h5>
`}return`<h5>${t}</h5>
<br>
`})(e.coverImageUrl),i;switch(e.type){case"image":{let d=e.body.images.map(l=>n.addFile(t,l.extension,l.originalUrl)).map(l=>n.getImageLinkTag(l)).join(`<br>
`),c=e.body.text.split(`
`).map(l=>`<span>${l}</span>`).join(`<br>
`);n.setHtml(o+d+`<br>
`+c),i=`${e.body.text}
`;break}case"file":{let d=e.body.files.map(l=>n.addFile(l.name,l.extension,l.url)).map(l=>n.getAutoAssignedLinkTag(l)).join(`<br>
`),c=e.body.text.split(`
`).map(l=>`<span>${l}</span>`).join(`<br>
`);n.setHtml(o+d+`<br>
`+c),i=`${e.body.text}
`;break}case"article":{let a=ie(e.body.imageMap,e.body.blocks).map(u=>n.addFile(t,u.extension,u.originalUrl)),d=re(e.body.fileMap,e.body.blocks).map(u=>n.addFile(u.name,u.extension,u.url)),c=ae(e.body.embedMap,e.body.blocks),l=ce(e.body.urlEmbedMap,e.body.blocks),x=0,g=0,f=0,b=0,y=e.body.blocks.map(u=>{switch(u.type){case"p":return`<span>${u.text}</span>`;case"header":return`<h2><span>${u.text}</span></h2>`;case"file":return n.getAutoAssignedLinkTag(d[g++]);case"image":return n.getImageLinkTag(a[x++]);case"embed":return`<span>${JSON.stringify(c[f++])}</span>`;case"url_embed":{let m=l[b++];switch(m.type){case"default":return n.getLinkTag(m.url,m.host);case"html":case"html.card":let p=m.html.match(/<iframe.*src="(http.*)"/)?.[1];return p?n.getLinkTag(p,"iframe link"):`
${m.html}

`;case"fanbox.post":let w=`https://www.fanbox.cc/@${m.postInfo.creatorId}/posts/${m.postInfo.id}`;return n.getLinkTag(w,m.postInfo.title);default:return`<span>${JSON.stringify(m)}</span>`}}default:return console.error(`unknown block type: ${u.type}`)}}).join(`<br>
`);n.setHtml(o+y),i=e.body.blocks.filter(u=>u.type==="p"||u.type==="header").map(u=>u.text).join(`
`)+`
`;break}case"text":{let a=e.body.text.split(`
`).map(d=>`<span>${d}</span>`).join(`<br>
`);i=e.body.text,n.setHtml(o+a);break}default:i=`\u4E0D\u660E\u306A\u30BF\u30A4\u30D7
${e.type}@${e.id}
`,console.log(`\u4E0D\u660E\u306A\u30BF\u30A4\u30D7
${e.type}@${e.id}`);break}let r={postId:e.id,title:e.title,creatorId:e.creatorId,fee:e.feeRequired,publishedDatetime:e.publishedDatetime,updatedDatetime:e.updatedDatetime,tags:e.tags,likeCount:e.likeCount,commentCount:e.commentCount};if(v.isExportJson)n.setInfo(JSON.stringify({...r,parsedText:i}));else{let a=Object.keys(r).map(d=>`${d}:${JSON.stringify(r[d])}`).join(`
`);n.setInfo(a+`
parsedText:
`+i)}s.decrementLimit()}function ie(s,e){let t=e.filter(o=>o.type==="image").map(o=>o.imageId),n=o=>t.indexOf(o)??t.length;return Object.keys(s).sort((o,i)=>n(o)-n(i)).map(o=>s[o])}function re(s,e){let t=e.filter(o=>o.type==="file").map(o=>o.fileId),n=o=>t.indexOf(o)??t.length;return Object.keys(s).sort((o,i)=>n(o)-n(i)).map(o=>s[o])}function ae(s,e){let t=e.filter(o=>o.type==="embed").map(o=>o.embedId),n=o=>t.indexOf(o)??t.length;return Object.keys(s).sort((o,i)=>n(o)-n(i)).map(o=>s[o])}function ce(s,e){let t=e.filter(o=>o.type==="url_embed").map(o=>o.urlEmbedId),n=o=>t.indexOf(o)??t.length;return Object.keys(s).sort((o,i)=>n(o)-n(i)).map(o=>s[o])}export{ze as main};
